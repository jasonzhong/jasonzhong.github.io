<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="http://yoursite.com/page/3/index.html">
<meta property="og:site_name" content="Hexo">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Hexo">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
  

</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://yoursite.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-Android-浅析-ContentProvider-四-启动原理" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/10/16/Android-浅析-ContentProvider-四-启动原理/" class="article-date">
  <time datetime="2015-10-16T08:50:50.000Z" itemprop="datePublished">2015-10-16</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/10/16/Android-浅析-ContentProvider-四-启动原理/">Android 浅析 ContentProvider (四) 启动原理</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <a id="more"></a>
<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><blockquote>
<p>Linus Benedict Torvalds : RTFSC – Read The Funning Source Code</p>
</blockquote>
<p>ContentProvider下文将会简称CP。<br>ContentResolver下文将会简称CR。</p>
<h2 id="CP-启动原理"><a href="#CP-启动原理" class="headerlink" title="CP 启动原理"></a>CP 启动原理</h2><blockquote>
<p>安装APK的时候，并不会把相应的Content Provider加载到内存中来，系统采取的是懒加载的机制，等到第一次使用这个Content Provider的时候，系统才会把它加载到内存中来，下次再要使用这个Content Provider的时候，就可以直接从内存读取了。</p>
</blockquote>
<p>ContentProvider 的启动原理从startProcessLocked开始，也就是Android的应用程序启动原理。</p>
<p>Step1.ActivityManagerService.startProcessLocked<br>Step2.Process.start<br>Step3.ActivityThread.main<br>Step4.ActivityThread.attach<br>Step5.ActivityManagerService.attachApplication</p>
<p>所以我们从attachApplication开始浅析</p>
<h3 id="ActivityManagerService"><a href="#ActivityManagerService" class="headerlink" title="ActivityManagerService"></a>ActivityManagerService</h3><h4 id="Step-1-attachApplicationLocked"><a href="#Step-1-attachApplicationLocked" class="headerlink" title="Step 1.attachApplicationLocked"></a>Step 1.attachApplicationLocked</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">attachApplicationLocked</span><span class="params">(</span></span></div><div class="line">    IApplicationThread thread, <span class="keyword">int</span> pid) &#123;</div><div class="line">    ProcessRecord app;</div><div class="line">    <span class="keyword">if</span> (pid != MY_PID &amp;&amp; pid &gt;= <span class="number">0</span>) &#123;</div><div class="line">        <span class="keyword">synchronized</span> (mPidsSelfLocked) &#123;</div><div class="line">            app = mPidsSelfLocked.get(pid);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    ...</div><div class="line">    app.makeActive(thread, mProcessStats);</div><div class="line">    app.curAdj = app.setAdj = -<span class="number">100</span>;</div><div class="line">    app.curSchedGroup = app.setSchedGroup = Process.THREAD_GROUP_DEFAULT;</div><div class="line">    app.forcingToForeground = <span class="keyword">null</span>;</div><div class="line">    updateProcessForegroundLocked(app, <span class="keyword">false</span>, <span class="keyword">false</span>);</div><div class="line">    app.hasShownUi = <span class="keyword">false</span>;</div><div class="line">    app.debugging = <span class="keyword">false</span>;</div><div class="line">    app.cached = <span class="keyword">false</span>;</div><div class="line">    app.killedByAm = <span class="keyword">false</span>;</div><div class="line">    ...</div><div class="line">    <span class="keyword">boolean</span> normalMode = mProcessesReady || isAllowedWhileBooting(app.info);</div><div class="line">    List&lt;ProviderInfo&gt; providers = normalMode ? generateApplicationProvidersLocked(app) : <span class="keyword">null</span>;</div><div class="line">    ...</div><div class="line">    <span class="keyword">try</span> &#123;  </div><div class="line">        ... </div><div class="line">        thread.bindApplication(processName, app.instrumentationInfo != <span class="keyword">null</span> ? app.instrumentationInfo : app.info, providers,  app.instrumentationClass, app.instrumentationProfileFile, app.instrumentationArguments, app.instrumentationWatcher, testMode, isRestrictedBackupMode || !normalMode, mConfiguration, getCommonServicesLocked());  </div><div class="line">        ... </div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">final</span> List&lt;ProviderInfo&gt; <span class="title">generateApplicationProvidersLocked</span><span class="params">(ProcessRecord app)</span> </span>&#123;</div><div class="line">    List&lt;ProviderInfo&gt; providers = <span class="keyword">null</span>;</div><div class="line">    providers = AppGlobals.getPackageManager().</div><div class="line">        queryContentProviders(app.processName, app.uid,</div><div class="line">        STOCK_PM_FLAGS | PackageManager.GET_URI_PERMISSION_PATTERNS);</div><div class="line"></div><div class="line">    <span class="keyword">int</span> userId = app.userId;</div><div class="line">    <span class="keyword">if</span> (providers != <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">int</span> N = providers.size();</div><div class="line">        app.pubProviders.ensureCapacity(N + app.pubProviders.size());</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;N; i++) &#123;</div><div class="line">            ProviderInfo cpi = (ProviderInfo)providers.get(i);</div><div class="line">            <span class="keyword">boolean</span> singleton = isSingleton(cpi.processName, cpi.applicationInfo, cpi.name, cpi.flags);</div><div class="line">            <span class="keyword">if</span> (singleton &amp;&amp; UserHandle.getUserId(app.uid) != <span class="number">0</span>) &#123;</div><div class="line">                providers.remove(i);</div><div class="line">                N--;</div><div class="line">                i--;</div><div class="line">                <span class="keyword">continue</span>;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            ComponentName comp = <span class="keyword">new</span> ComponentName(cpi.packageName, cpi.name);</div><div class="line">            ContentProviderRecord cpr = mProviderMap.getProviderByClass(comp, userId);</div><div class="line">            <span class="keyword">if</span> (cpr == <span class="keyword">null</span>) &#123;</div><div class="line">                cpr = <span class="keyword">new</span> ContentProviderRecord(<span class="keyword">this</span>, cpi, app.info, comp, singleton);</div><div class="line">                mProviderMap.putProviderByClass(comp, cpr);</div><div class="line">            &#125;</div><div class="line">            app.pubProviders.put(cpi.name, cpr);</div><div class="line">            <span class="keyword">if</span> (!cpi.multiprocess || !<span class="string">"android"</span>.equals(cpi.packageName)) &#123;</div><div class="line">                app.addPackage(cpi.applicationInfo.packageName, cpi.applicationInfo.versionCode,</div><div class="line">                        mProcessStats);</div><div class="line">            &#125;</div><div class="line">            ensurePackageDexOpt(cpi.applicationInfo.packageName);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> providers;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这里首先根据传进来的进程ID找到相应的进程记录块，然后对这个进程记录块做一些初倾始化的工作。接下来通过调用generateApplicationProvidersLocked获得需要在这个过程中加载的Content Provider列表，最后调用从参数传进来的IApplicationThread对象thread的bindApplication函数来执行一些应用程序初始化工作。</p>
<h3 id="ActivityThread"><a href="#ActivityThread" class="headerlink" title="ActivityThread"></a>ActivityThread</h3><h4 id="Step-2-bindApplication"><a href="#Step-2-bindApplication" class="headerlink" title="Step 2.bindApplication"></a>Step 2.bindApplication</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">bindApplication</span><span class="params">(String processName, ApplicationInfo appInfo,</span></span></div><div class="line">        List&lt;ProviderInfo&gt; providers, ComponentName instrumentationName,</div><div class="line">        ProfilerInfo profilerInfo, Bundle instrumentationArgs,</div><div class="line">        IInstrumentationWatcher instrumentationWatcher,</div><div class="line">        IUiAutomationConnection instrumentationUiConnection, <span class="keyword">int</span> debugMode,</div><div class="line">        <span class="keyword">boolean</span> enableOpenGlTrace, <span class="keyword">boolean</span> isRestrictedBackupMode, <span class="keyword">boolean</span> persistent,</div><div class="line">        Configuration config, CompatibilityInfo compatInfo, Map&lt;String, IBinder&gt; services,</div><div class="line">        Bundle coreSettings) &#123;</div><div class="line">    <span class="keyword">if</span> (services != <span class="keyword">null</span>) &#123;</div><div class="line">        ServiceManager.initServiceCache(services);</div><div class="line">    &#125;</div><div class="line">    setCoreSettings(coreSettings);</div><div class="line">    ...</div><div class="line">    AppBindData data = <span class="keyword">new</span> AppBindData();</div><div class="line">    data.processName = processName;</div><div class="line">    data.appInfo = appInfo;</div><div class="line">    data.providers = providers;</div><div class="line">    data.instrumentationName = instrumentationName;</div><div class="line">    data.instrumentationArgs = instrumentationArgs;</div><div class="line">    data.instrumentationWatcher = instrumentationWatcher;</div><div class="line">    data.instrumentationUiAutomationConnection = instrumentationUiConnection;</div><div class="line">    data.debugMode = debugMode;</div><div class="line">    data.enableOpenGlTrace = enableOpenGlTrace;</div><div class="line">    data.restrictedBackupMode = isRestrictedBackupMode;</div><div class="line">    data.persistent = persistent;</div><div class="line">    data.config = config;</div><div class="line">    data.compatInfo = compatInfo;</div><div class="line">    data.initProfilerInfo = profilerInfo;</div><div class="line">    sendMessage(H.BIND_APPLICATION, data);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>bindApplication把相关的信息都封装成一个AppBindData对象，然后以一个消息的形式发送到主线程的消息队列中去等等待处理。这个消息最终是是在ActivityThread类的handleBindApplication函数中进行处理的。</p>
<h4 id="Step-3-handleBindApplication"><a href="#Step-3-handleBindApplication" class="headerlink" title="Step 3.handleBindApplication"></a>Step 3.handleBindApplication</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">handleBindApplication</span><span class="params">(AppBindData data)</span> </span>&#123;  </div><div class="line">    ... </div><div class="line">    List&lt;ProviderInfo&gt; providers = data.providers;  </div><div class="line">    <span class="keyword">if</span> (providers != <span class="keyword">null</span>) &#123;  </div><div class="line">        installContentProviders(app, providers);  </div><div class="line">        ... </div><div class="line">    &#125;  </div><div class="line">    ...  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这个函数有很多内容，其中对于Provider就是调用installContentProviders函数来在本地安装Content Providers信息。</p>
<h4 id="Step-4-installContentProviders"><a href="#Step-4-installContentProviders" class="headerlink" title="Step 4.installContentProviders"></a>Step 4.installContentProviders</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">installContentProviders</span><span class="params">(</span></span></div><div class="line">        Context context, List&lt;ProviderInfo&gt; providers) &#123;</div><div class="line">    <span class="keyword">final</span> ArrayList&lt;IActivityManager.ContentProviderHolder&gt; results =</div><div class="line">        <span class="keyword">new</span> ArrayList&lt;IActivityManager.ContentProviderHolder&gt;();</div><div class="line"></div><div class="line">    <span class="keyword">for</span> (ProviderInfo cpi : providers) &#123;</div><div class="line">        IActivityManager.ContentProviderHolder cph = installProvider(context, <span class="keyword">null</span>, cpi,</div><div class="line">                <span class="keyword">false</span> <span class="comment">/*noisy*/</span>, <span class="keyword">true</span> <span class="comment">/*noReleaseNeeded*/</span>, <span class="keyword">true</span> <span class="comment">/*stable*/</span>);</div><div class="line">        <span class="keyword">if</span> (cph != <span class="keyword">null</span>) &#123;</div><div class="line">            cph.noReleaseNeeded = <span class="keyword">true</span>;</div><div class="line">            results.add(cph);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    ActivityManagerNative.getDefault().publishContentProviders(</div><div class="line">        getApplicationThread(), results);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>installContentProviders做了两件事，第一件是调用installProvider来在本地安装每一个Content Proivder的信息，并且为每一个Content Provider创建一个ContentProviderHolder对象来保存相关的信息。第二件就是调用ActivityManagerService服务的publishContentProviders函数来通知ActivityManagerService服务，这个进程中所要加载的Content Provider，都已经准备完毕。</p>
<h4 id="Step-5-installProvider"><a href="#Step-5-installProvider" class="headerlink" title="Step 5.installProvider"></a>Step 5.installProvider</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> IActivityManager.<span class="function">ContentProviderHolder <span class="title">installProvider</span><span class="params">(Context context,</span></span></div><div class="line">        IActivityManager.ContentProviderHolder holder, ProviderInfo info,</div><div class="line">        <span class="keyword">boolean</span> noisy, <span class="keyword">boolean</span> noReleaseNeeded, <span class="keyword">boolean</span> stable) &#123;</div><div class="line">    ContentProvider localProvider = <span class="keyword">null</span>;</div><div class="line">    IContentProvider provider;</div><div class="line">    <span class="keyword">if</span> (holder == <span class="keyword">null</span> || holder.provider == <span class="keyword">null</span>) &#123;</div><div class="line">        Context c = <span class="keyword">null</span>;</div><div class="line">        ApplicationInfo ai = info.applicationInfo;</div><div class="line">        <span class="keyword">if</span> (context.getPackageName().equals(ai.packageName)) &#123;</div><div class="line">            c = context;</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mInitialApplication != <span class="keyword">null</span> &amp;&amp;</div><div class="line">                mInitialApplication.getPackageName().equals(ai.packageName)) &#123;</div><div class="line">            c = mInitialApplication;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            c = context.createPackageContext(ai.packageName,</div><div class="line">                    Context.CONTEXT_INCLUDE_CODE);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">final</span> java.lang.ClassLoader cl = c.getClassLoader();</div><div class="line">        localProvider = (ContentProvider)cl.</div><div class="line">            loadClass(info.name).newInstance();</div><div class="line">        provider = localProvider.getIContentProvider();</div><div class="line">        localProvider.attachInfo(c, info);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        provider = holder.provider;</div><div class="line">    &#125;</div><div class="line">    IActivityManager.ContentProviderHolder retHolder;</div><div class="line">    <span class="keyword">synchronized</span> (mProviderMap) &#123;</div><div class="line">        IBinder jBinder = provider.asBinder();</div><div class="line">        <span class="keyword">if</span> (localProvider != <span class="keyword">null</span>) &#123;</div><div class="line">            ComponentName cname = <span class="keyword">new</span> ComponentName(info.packageName, info.name);</div><div class="line">            ProviderClientRecord pr = mLocalProvidersByName.get(cname);</div><div class="line">            <span class="keyword">if</span> (pr != <span class="keyword">null</span>) &#123;</div><div class="line">                provider = pr.mProvider;</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                holder = <span class="keyword">new</span> IActivityManager.ContentProviderHolder(info);</div><div class="line">                holder.provider = provider;</div><div class="line">                holder.noReleaseNeeded = <span class="keyword">true</span>;</div><div class="line">                pr = installProviderAuthoritiesLocked(provider, localProvider, holder);</div><div class="line">                mLocalProviders.put(jBinder, pr);</div><div class="line">                mLocalProvidersByName.put(cname, pr);</div><div class="line">            &#125;</div><div class="line">            retHolder = pr.mHolder;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            ProviderRefCount prc = mProviderRefCountMap.get(jBinder);</div><div class="line">            <span class="keyword">if</span> (prc != <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="keyword">if</span> (!noReleaseNeeded) &#123;</div><div class="line">                    incProviderRefLocked(prc, stable);</div><div class="line">                    ActivityManagerNative.getDefault().removeContentProvider(holder.connection, stable);</div><div class="line">                &#125;</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                ProviderClientRecord client = installProviderAuthoritiesLocked(provider, localProvider, holder);</div><div class="line">                <span class="keyword">if</span> (noReleaseNeeded) &#123;</div><div class="line">                    prc = <span class="keyword">new</span> ProviderRefCount(holder, client, <span class="number">1000</span>, <span class="number">1000</span>);</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    prc = stable ? <span class="keyword">new</span> ProviderRefCount(holder, client, <span class="number">1</span>, <span class="number">0</span>) : <span class="keyword">new</span> ProviderRefCount(holder, client, <span class="number">0</span>, <span class="number">1</span>);</div><div class="line">                &#125;</div><div class="line">                mProviderRefCountMap.put(jBinder, prc);</div><div class="line">            &#125;</div><div class="line">            retHolder = prc.holder;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> retHolder;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>installProvider主要是在应用程序进程中把相应的Content Provider类加载进来。</p>
<p>先来看下其中的localProvider.getIContentProvider()函数，它是从ContentProvider中返回该对象的。</p>
<h3 id="ContentProvider"><a href="#ContentProvider" class="headerlink" title="ContentProvider"></a>ContentProvider</h3><h4 id="Step-6-getIContentProvider"><a href="#Step-6-getIContentProvider" class="headerlink" title="Step 6.getIContentProvider"></a>Step 6.getIContentProvider</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">ContentProvider</span> <span class="keyword">implements</span> <span class="title">ComponentCallbacks</span> </span>&#123;  </div><div class="line">    ...</div><div class="line">    <span class="keyword">private</span> Transport mTransport = <span class="keyword">new</span> Transport();  </div><div class="line">    ...</div><div class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Transport</span> <span class="keyword">extends</span> <span class="title">ContentProviderNative</span> </span>&#123;  </div><div class="line">        ...</div><div class="line">    &#125;  </div><div class="line">    <span class="function"><span class="keyword">public</span> IContentProvider <span class="title">getIContentProvider</span><span class="params">()</span> </span>&#123;  </div><div class="line">        <span class="keyword">return</span> mTransport;  </div><div class="line">    &#125;  </div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ContentProvider类和Transport类的关系就类似于ActivityThread和ApplicationThread的关系，其它应用程序不是直接调用ContentProvider接口来访问它的数据，而是通过调用它的内部对象mTransport来间接调用ContentProvider的接口。</p>
<p>接着我们来看localProvider.attachInfo(c, info)函数，通过它可以开始初始化Provider。</p>
<h4 id="Step-7-attachInfo"><a href="#Step-7-attachInfo" class="headerlink" title="Step 7.attachInfo"></a>Step 7.attachInfo</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">attachInfo</span><span class="params">(Context context, ProviderInfo info, <span class="keyword">boolean</span> testing)</span> </span>&#123;</div><div class="line">    mNoPerms = testing;</div><div class="line">    <span class="keyword">if</span> (mContext == <span class="keyword">null</span>) &#123;</div><div class="line">        mContext = context;</div><div class="line">        <span class="keyword">if</span> (context != <span class="keyword">null</span>) &#123;</div><div class="line">            mTransport.mAppOpsManager = (AppOpsManager) context.getSystemService(</div><div class="line">                    Context.APP_OPS_SERVICE);</div><div class="line">        &#125;</div><div class="line">        mMyUid = Process.myUid();</div><div class="line">        <span class="keyword">if</span> (info != <span class="keyword">null</span>) &#123;</div><div class="line">            setReadPermission(info.readPermission);</div><div class="line">            setWritePermission(info.writePermission);</div><div class="line">            setPathPermissions(info.pathPermissions);</div><div class="line">            mExported = info.exported;</div><div class="line">            mSingleUser = (info.flags &amp; ProviderInfo.FLAG_SINGLE_USER) != <span class="number">0</span>;</div><div class="line">            setAuthorities(info.authority);</div><div class="line">        &#125;</div><div class="line">        ContentProvider.<span class="keyword">this</span>.onCreate();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>主要就是根据这个Content Provider的信息info来设置相应的读写权限，然后调用它的子类的onCreate函数来让子类执行一些初始化的工作。</p>
<p>接着回到Step 5.installProvider</p>
<h3 id="ActivityThread-1"><a href="#ActivityThread-1" class="headerlink" title="ActivityThread"></a>ActivityThread</h3><h4 id="Step-8-gt-Step-5-installProvider"><a href="#Step-8-gt-Step-5-installProvider" class="headerlink" title="Step 8 -&gt;Step 5.installProvider"></a>Step 8 -&gt;Step 5.installProvider</h4><p>在ActivityThread中，以Content Provider的authority为键值来把这个Content Provider的信息保存在mProviderMap成员变量中，因为一个Content Provider可以对应多个authority，因此这里用一个for循环来处理，同时又以这个Content Provider对应的Binder对象provider来键值来把这个Content Provider的信息保存在mLocalProviders成员变量中，表明这是一个在本地加载的Content Provider。</p>
<p>接着返回到Step 4 instalContentProviders</p>
<h4 id="Step-9-publishContentProviders"><a href="#Step-9-publishContentProviders" class="headerlink" title="Step 9.publishContentProviders"></a>Step 9.publishContentProviders</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">publishContentProviders</span><span class="params">(</span></span></div><div class="line">    IApplicationThread caller,</div><div class="line">    List&lt;ContentProviderHolder&gt; providers) &#123;</div><div class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</div><div class="line">        <span class="keyword">final</span> ProcessRecord r = getRecordForAppLocked(caller);</div><div class="line">        <span class="keyword">final</span> <span class="keyword">long</span> origId = Binder.clearCallingIdentity();</div><div class="line"></div><div class="line">        <span class="keyword">final</span> <span class="keyword">int</span> N = providers.size();</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;N; i++) &#123;</div><div class="line">            ContentProviderHolder src = providers.get(i);</div><div class="line">            <span class="keyword">if</span> (src == <span class="keyword">null</span> || src.info == <span class="keyword">null</span> || src.provider == <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="keyword">continue</span>;</div><div class="line">            &#125;</div><div class="line">            ContentProviderRecord dst = r.pubProviders.get(src.info.name);</div><div class="line">            <span class="keyword">if</span> (dst != <span class="keyword">null</span>) &#123;</div><div class="line">                ComponentName comp = <span class="keyword">new</span> ComponentName(dst.info.packageName, dst.info.name);</div><div class="line">                mProviderMap.putProviderByClass(comp, dst);</div><div class="line">                String names[] = dst.info.authority.split(<span class="string">";"</span>);</div><div class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; names.length; j++) &#123;</div><div class="line">                    mProviderMap.putProviderByName(names[j], dst);</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                <span class="keyword">int</span> NL = mLaunchingProviders.size();</div><div class="line">                <span class="keyword">int</span> j;</div><div class="line">                <span class="keyword">for</span> (j=<span class="number">0</span>; j&lt;NL; j++) &#123;</div><div class="line">                    <span class="keyword">if</span> (mLaunchingProviders.get(j) == dst) &#123;</div><div class="line">                        mLaunchingProviders.remove(j);</div><div class="line">                        j--;</div><div class="line">                        NL--;</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">synchronized</span> (dst) &#123;</div><div class="line">                    dst.provider = src.provider;</div><div class="line">                    dst.proc = r;</div><div class="line">                    dst.notifyAll();</div><div class="line">                &#125;</div><div class="line">                updateOomAdjLocked(r);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        Binder.restoreCallingIdentity(origId);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>此函数调用的作用就是通知ActivityMangerService，需要在这个进程中加载的Content Provider已经完加载完成。在这句函数最后执行了dst.notiryAll语句会通知之前加载的线程要被唤醒。</p>
<p>最后将会返回getProvider函数中执行接下来的installProvider()</p>
<h4 id="Step-10-installProvider"><a href="#Step-10-installProvider" class="headerlink" title="Step 10 .installProvider"></a>Step 10 .installProvider</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">holder = installProvider(c, holder, holder.info,</div><div class="line">        <span class="keyword">true</span> <span class="comment">/*noisy*/</span>, holder.noReleaseNeeded, stable);</div></pre></td></tr></table></figure>
<p>与Step 5不同，这里传进来的参数provider是不为null的，因此，它不需要执行在本地加载Content Provider的工作，只需要把从ActivityMangerService中获得的Content Provider接口保存在成员变量mProviderMap中就可以了。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2015/10/16/Android-浅析-ContentProvider-四-启动原理/" data-id="civ9405s7000makqtd8yh9wxq" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Android/">Android</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Android-基础知识/">Android_基础知识</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ContentProvider/">ContentProvider</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Android-浅析-ContentProvider-三-获取原理" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/10/16/Android-浅析-ContentProvider-三-获取原理/" class="article-date">
  <time datetime="2015-10-16T08:13:38.000Z" itemprop="datePublished">2015-10-16</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/10/16/Android-浅析-ContentProvider-三-获取原理/">Android 浅析 ContentProvider (三) 获取原理</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <a id="more"></a>
<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><blockquote>
<p>Linus Benedict Torvalds : RTFSC – Read The Funning Source Code</p>
</blockquote>
<p>ContentProvider下文将会简称CP。<br>ContentResolver下文将会简称CR。</p>
<h2 id="概括"><a href="#概括" class="headerlink" title="概括"></a>概括</h2><blockquote>
<p>本文首先从ContentResolver一路深入浅析CP客户端如何找到对应的provider。</p>
</blockquote>
<h2 id="CP-获取原理"><a href="#CP-获取原理" class="headerlink" title="CP 获取原理"></a>CP 获取原理</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Cursor cursor = context.getContentResolver().query(uri, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>);</div></pre></td></tr></table></figure>
<p>这是CP客户端用来启动服务端的代码。在获取到cursor后就可以从中取出数据集。</p>
<p>我们首先通过getContentResolver()来获取一个ContentResolve对象。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> ApplicationContentResolver mContentResolver;</div><div class="line"><span class="function"><span class="keyword">public</span> ContentResolver <span class="title">getContentResolver</span><span class="params">()</span> </span>&#123;<span class="keyword">return</span> mContentResolver;&#125;</div></pre></td></tr></table></figure></p>
<p>通过代码我们可以知道返回的mContentResolver对象是ApplicationContentResolver类，而ApplicationContentResolver类又是继承于ContentResolver的。所以我们接下来首先分析下ContentResolver。</p>
<h3 id="Step1、ContentResolver"><a href="#Step1、ContentResolver" class="headerlink" title="Step1、ContentResolver"></a>Step1、ContentResolver</h3><blockquote>
<p>SDK：provides applications access to the content model.<br>翻译：提供app访问内容模型。</p>
</blockquote>
<p>CR 通过一套标准及统一的接口获取其他应用程序暴露的数据，那个标准就是URI，除了URI以外，还必须知道需要获取的数据段的名称，以及此数据段的数据类型。</p>
<h4 id="主要方法"><a href="#主要方法" class="headerlink" title="主要方法"></a>主要方法</h4><p>因为CP是以类似数据库中表的方式将数据暴露出去，那么CR也将采用类似数据库的操作来从CP中获取数据。</p>
<h5 id="insert"><a href="#insert" class="headerlink" title="insert"></a>insert</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="meta">@Nullable</span> <span class="function">Uri <span class="title">insert</span><span class="params">(@NonNull Uri url, @Nullable ContentValues values)</span></span>&#123;&#125;</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">bulkInsert</span><span class="params">(@NonNull Uri url, @NonNull ContentValues[] values)</span></span>&#123;&#125;</div></pre></td></tr></table></figure>
<p>insert:<br>Inserts a row into a table at the given URL.<br>If the content provider supports transactions the insertion will be atomic.<br>翻译：在给定的URL插入一行到表里面，如果CP支持，处理过程将是原子操作。</p>
<p>bulkInsert:<br>Inserts multiple rows into a table at the given URL.<br>This function make no guarantees about the atomicity of the insertions.<br>翻译：在给定的URL插入多行到表里面，处理过程不对原子操作作保证。</p>
<h5 id="delete"><a href="#delete" class="headerlink" title="delete"></a>delete</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">delete</span><span class="params">(Uri url, String where, String[] selectionArgs)</span></span>&#123;&#125;</div></pre></td></tr></table></figure>
<p>Deletes row(s) specified by a content URI.<br>If the content provider supports transactions, the deletion will be atomic.<br>翻译：删除一行或多行由uri指定，如果CP支持，处理过程将是原子操作。</p>
<h5 id="update"><a href="#update" class="headerlink" title="update"></a>update</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">update</span><span class="params">(Uri uri, ContentValues values, String where,</span></span></div><div class="line">            String[] selectionArgs) &#123;&#125;</div></pre></td></tr></table></figure>
<p>Update row(s) in a content URI.<br>If the content provider supports transactions the update will be atomic.<br>翻译：在给定的URL更新多行，如果CP支持，处理过程将是原子操作。</p>
<h5 id="Query"><a href="#Query" class="headerlink" title="Query"></a>Query</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> Cursor <span class="title">query</span><span class="params">(Uri uri, String[] projection,</span></span></div><div class="line">            String selection, String[] selectionArgs, String sortOrder) &#123;&#125;</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> Cursor <span class="title">query</span><span class="params">(<span class="keyword">final</span> Uri uri, String[] projection,</span></span></div><div class="line">            String selection, String[] selectionArgs, String sortOrder,</div><div class="line">            CancellationSignal cancellationSignal) &#123;&#125;</div></pre></td></tr></table></figure>
<p>Query the given URI, returning a Cursor over the result set.<br>翻译：从给定的URI中查询，从结果集中返回一个Cursor对象。<br>注意：<br>1：提供一个明确的空间，防止从不希望被使用的内存中读取数据。<br>2：使用问号参数标记，如“电话=？”而不是在选择参数中的显式值，因此，不同的值的查询将被确认为缓存的目的相同的。</p>
<h5 id="call"><a href="#call" class="headerlink" title="call"></a>call</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> Bundle <span class="title">call</span><span class="params">(Uri uri, String method, String arg, Bundle extras)</span> </span>&#123;&#125;</div></pre></td></tr></table></figure>
<p>Call a provider-defined method. This can be used to implement read or write interfaces which are cheaper than using a Cursor and/or do not fit into the traditional table model.<br>翻译：<br>调用提供者定义方法。这可以用来实现读写接口，比使用游标和/或不符合传统的表模型更好。</p>
<h4 id="核心方法"><a href="#核心方法" class="headerlink" title="核心方法"></a>核心方法</h4><p>在insert、query、updata这些方法中都调用一个最主要的方法acquireProvider()。</p>
<h5 id="acquireProvider"><a href="#acquireProvider" class="headerlink" title="acquireProvider"></a>acquireProvider</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//Returns the content provider for the given content URI.</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> IContentProvider <span class="title">acquireUnstableProvider</span><span class="params">(Uri uri)</span> </span>&#123;</div><div class="line">    ...</div><div class="line">    <span class="keyword">return</span> acquireUnstableProvider(mContext, uri.getAuthority());</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>acquireProvider()是一个抽象函数，由子类去实现细节。那么在android中，实现细节的子类就是<strong>ApplicationContentResolver</strong>。</p>
<h3 id="Step2、ApplicationContentResolver"><a href="#Step2、ApplicationContentResolver" class="headerlink" title="Step2、ApplicationContentResolver"></a>Step2、ApplicationContentResolver</h3><blockquote>
<p>ApplicationContentResolver是contextimpl的内部类，继承ContentResolver。其内部封装了一个ActivityThread对象，最后调用的方法都是调用ActivityThread的方法，所以ApplicationContentResolver就是一个中间过度类。</p>
</blockquote>
<p>接着我们来看下ActivityThread关于acquireProvider()的核心方法：</p>
<h3 id="Step3、ActivityThread"><a href="#Step3、ActivityThread" class="headerlink" title="Step3、ActivityThread"></a>Step3、ActivityThread</h3><p>acquireProvider：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> IContentProvider <span class="title">acquireProvider</span><span class="params">(</span></span></div><div class="line">            Context c, String auth, <span class="keyword">int</span> userId, <span class="keyword">boolean</span> stable) &#123;</div><div class="line">    <span class="keyword">final</span> IContentProvider provider = acquireExistingProvider(c, auth, userId, stable);</div><div class="line">    <span class="keyword">if</span> (provider != <span class="keyword">null</span>) &#123;<span class="keyword">return</span> provider;&#125;</div><div class="line"></div><div class="line">    IActivityManager.ContentProviderHolder holder = <span class="keyword">null</span>;</div><div class="line">    holder = ActivityManagerNative.getDefault().getContentProvider(</div><div class="line">            getApplicationThread(), auth, userId, stable);</div><div class="line">    <span class="keyword">if</span> (holder == <span class="keyword">null</span>) &#123;<span class="keyword">return</span> <span class="keyword">null</span>;&#125;</div><div class="line"></div><div class="line">    holder = installProvider(c, holder, holder.info,</div><div class="line">                <span class="keyword">true</span> <span class="comment">/*noisy*/</span>, holder.noReleaseNeeded, stable);</div><div class="line">    <span class="keyword">return</span> holder.provider;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这段函数主要流程：<br>1、从已经保存的本地provider中查找是否有对应的provider，有则将其返回退出。<br>2、从AMS中找到对应的provider。<br>3、安装从AMS中找到的provider。并且将provider保存在本地。<br>4、返回此provider。</p>
<p>最后我们来看下ActivityManagerService关于getContentProvider()的核心方法：</p>
<h3 id="Step4、ActivityManagerService"><a href="#Step4、ActivityManagerService" class="headerlink" title="Step4、ActivityManagerService"></a>Step4、ActivityManagerService</h3><p>getContentProvider:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> ContentProviderHolder <span class="title">getContentProvider</span><span class="params">(</span></span></div><div class="line">            IApplicationThread caller, String name, <span class="keyword">int</span> userId, <span class="keyword">boolean</span> stable) &#123;</div><div class="line">    enforceNotIsolatedCaller(<span class="string">"getContentProvider"</span>);</div><div class="line">    <span class="keyword">return</span> getContentProviderImpl(caller, name, <span class="keyword">null</span>, stable, userId);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">final</span> ContentProviderHolder <span class="title">getContentProviderImpl</span><span class="params">(IApplicationThread caller,</span></span></div><div class="line">            String name, IBinder token, <span class="keyword">boolean</span> stable, <span class="keyword">int</span> userId) &#123;</div><div class="line">    ...</div><div class="line">    ContentProviderRecord cpr;</div><div class="line">    </div><div class="line">    <span class="comment">// First check if this content provider has been published...</span></div><div class="line">    cpr = mProviderMap.getProviderByName(name, userId);</div><div class="line">    ...</div><div class="line">    <span class="keyword">if</span> (!providerRunning) &#123;</div><div class="line">        cpi = AppGlobals.getPackageManager().resolveContentProvider(name, STOCK_PM_FLAGS | PackageManager.GET_URI_PERMISSION_PATTERNS, userId);</div><div class="line">    &#125;         </div><div class="line">    ...</div><div class="line">    cpr = mProviderMap.getProviderByClass(comp, userId);</div><div class="line">    <span class="keyword">if</span> (firstClass) &#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            ApplicationInfo ai = AppGlobals.getPackageManager().</div><div class="line">                getApplicationInfo(cpi.applicationInfo.packageName, STOCK_PM_FLAGS, userId);</div><div class="line">            cpr = <span class="keyword">new</span> ContentProviderRecord(<span class="keyword">this</span>, cpi, ai, comp, singleton);</div><div class="line">        &#125; <span class="keyword">finally</span> &#123;</div><div class="line">            Binder.restoreCallingIdentity(ident);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    ...</div><div class="line">    <span class="keyword">if</span> (firstClass) &#123;</div><div class="line">        mProviderMap.putProviderByClass(comp, cpr);</div><div class="line">    &#125;</div><div class="line">    mProviderMap.putProviderByName(name, cpr);</div><div class="line">    ...</div><div class="line">    <span class="comment">// Wait for the provider to be published... </span></div><div class="line">    <span class="keyword">synchronized</span> (cpr) &#123;  </div><div class="line">        <span class="keyword">while</span> (cpr.provider == <span class="keyword">null</span>) &#123;  </div><div class="line">            ......  </div><div class="line">            <span class="keyword">try</span> &#123;  </div><div class="line">                cpr.wait();  </div><div class="line">            &#125; </div><div class="line">        &#125;  </div><div class="line">    &#125;  </div><div class="line">    <span class="keyword">return</span> cpr != <span class="keyword">null</span> ? cpr.newHolder(conn) : <span class="keyword">null</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这段函数主要从AMS中查找已经注册了的provider，然后将provider对象返回给客户端。<br>在ActivityManagerService中，有两个成员变量是用来保存系统中的Content Provider信息的，一个是mProvidersByName，一个是mProvidersByClass，前者是以Content Provider的authoriry值为键值来保存的，后者是以Content Provider的类名为键值来保存的。这里要用两个Map来保存，这里为了方便根据不同条件来快速查找而设计的。<br>如果在mProviderMap里找不到对应的provider，会通过AppGlobals.getPackageManager()从PackageManagerService里获取。然后保存到mProviderMap里面。</p>
<h3 id="Step5、PackageManagerService"><a href="#Step5、PackageManagerService" class="headerlink" title="Step5、PackageManagerService"></a>Step5、PackageManagerService</h3><p>resolveContentProvider:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> ProviderInfo <span class="title">resolveContentProvider</span><span class="params">(String name, <span class="keyword">int</span> flags, <span class="keyword">int</span> userId)</span> </span>&#123;</div><div class="line">    <span class="keyword">synchronized</span> (mPackages) &#123;</div><div class="line">        <span class="keyword">final</span> PackageParser.Provider provider = mProvidersByAuthority.get(name);</div><div class="line">        PackageSetting ps = mSettings.mPackages.get(provider.owner.packageName);</div><div class="line">        <span class="keyword">return</span> PackageParser.generateProviderInfo(provider, flags,</div><div class="line">                        ps.readUserState(userId), userId);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>查找的最底层就是在PMS里面，PMS里面的mProvidersByAuthority保存了本机所有apk包含的provider定义。通过它可以找到所有对应的provider。(终)</p>
<h3 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h3><p>ContentProvider的整个获取原理比较简单，并没有太难的地方，主要还是一层层调用比较费劲，封装了几层。<br>再来总结下获取的整个流程(以query函数为例)：<br>1、首先每个context类都会内部包含了一个ContentResolver的子对象ApplicationContentResolver。<br>2、通过调用ApplicationContentResolver的主要方法query来获取CP的数据库数据。<br>3、调用的过程首先会调用ContentResolver的核心方法acquireProvider()。而acquireProvider()方法是一个抽象方法，其实现是交由子类实现。<br>4、通过子类的acquireProvider()方法实现了解到主要的实现是交由ActivityThread类来完成。<br>5、ActivityThread类会做出一个判断，如果本地保存一个需要获取的CP对象实例，就会直接返回这个对象实例，如果没有保存，则会访问AMS对象去查找获取一个对象的CP对象实例，当找到这个对象实例后会保存到本地以便日后快速获取。<br>6、如果在AMS里面没有找到，就会继续深入到PMS里去从全部的provider中查找。<br>7、获取到CP对象实例后会通过层层返回，最后再调用该CP对象的query方法获取相应的数据。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2015/10/16/Android-浅析-ContentProvider-三-获取原理/" data-id="civ9405rs000hakqttboccex5" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Android/">Android</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Android-基础知识/">Android_基础知识</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ContentProvider/">ContentProvider</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Android-浅析-ContentProvider-二-安装原理" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/10/16/Android-浅析-ContentProvider-二-安装原理/" class="article-date">
  <time datetime="2015-10-16T07:19:05.000Z" itemprop="datePublished">2015-10-16</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/10/16/Android-浅析-ContentProvider-二-安装原理/">Android 浅析 ContentProvider (二) 安装原理</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <a id="more"></a>
<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><blockquote>
<p>Linus Benedict Torvalds : RTFSC – Read The Funning Source Code</p>
</blockquote>
<p>ContentProvider下文将会简称CP。<br>ContentResolver下文将会简称CR。</p>
<h2 id="概括"><a href="#概括" class="headerlink" title="概括"></a>概括</h2><blockquote>
<p>ContentProvider的安装原理其实就是Apk的安装原理，这里仅仅分析从安装过程中安装provider的过程。</p>
</blockquote>
<h2 id="CP-安装原理"><a href="#CP-安装原理" class="headerlink" title="CP 安装原理"></a>CP 安装原理</h2><h3 id="PackageManagerService"><a href="#PackageManagerService" class="headerlink" title="PackageManagerService"></a>PackageManagerService</h3><blockquote>
<p>负责系统中Package的管理，应用程序的安装、卸载、信息查询等。</p>
</blockquote>
<p>我们的安装流程从scanDirLI()开始，无论是android开机安装还是手动安装还是其他安装方式，最终都会走到PMS的scanDirLI()函数里面，对于我们provider的安装从scanDirLI()开始就够了。</p>
<h4 id="Step1、scanDirLI"><a href="#Step1、scanDirLI" class="headerlink" title="Step1、scanDirLI()"></a>Step1、scanDirLI()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">scanDirLI</span><span class="params">(File dir, <span class="keyword">int</span> parseFlags, <span class="keyword">int</span> scanFlags, <span class="keyword">long</span> currentTime)</span> </span>&#123;</div><div class="line">    <span class="keyword">final</span> File[] files = dir.listFiles();</div><div class="line">    ...</div><div class="line">    scanPackageLI(file, parseFlags | PackageParser.PARSE_MUST_BE_APK,</div><div class="line">            scanFlags, currentTime, <span class="keyword">null</span>);</div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这个函数会对于后缀为APK的文件进行解析和安装。</p>
<h4 id="Step2、scanPackageLI"><a href="#Step2、scanPackageLI" class="headerlink" title="Step2、scanPackageLI()"></a>Step2、scanPackageLI()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> PackageParser.<span class="function">Package <span class="title">scanPackageLI</span><span class="params">(File scanFile, <span class="keyword">int</span> parseFlags, <span class="keyword">int</span> scanFlags,</span></span></div><div class="line">            <span class="keyword">long</span> currentTime, UserHandle user) &#123;</div><div class="line">    ...</div><div class="line">    parseFlags |= mDefParseFlags;</div><div class="line">    PackageParser pp = <span class="keyword">new</span> PackageParser();</div><div class="line">    ...</div><div class="line">    <span class="keyword">final</span> PackageParser.Package pkg;</div><div class="line">    pkg = pp.parsePackage(scanFile, parseFlags);</div><div class="line">    ...</div><div class="line">    <span class="keyword">if</span> (replace) &#123;</div><div class="line">        replacePackageLI(pkg, parseFlags, scanFlags | SCAN_REPLACING, args.user,</div><div class="line">            installerPackageName, volumeUuid, res);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        installNewPackageLI(pkg, parseFlags, scanFlags | SCAN_DELETE_DATA_ON_FAILURES,</div><div class="line">            args.user, installerPackageName, volumeUuid, res);</div><div class="line">    &#125;</div><div class="line">    ...</div><div class="line">    <span class="keyword">return</span> scannedPkg;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这个函数首先会为这个Apk文件创建一个PackageParser实例，接着调用这个实例的parsePackage函数来对这个Apk文件进行解析。这个函数最后还会调用另外一个scanPackageLI函数来把解析后得到的应用程序信息保存在PackageManagerService中，其中就包括Provider信息。</p>
<h4 id="Step3、PackageParser-parsePackage"><a href="#Step3、PackageParser-parsePackage" class="headerlink" title="Step3、PackageParser.parsePackage()"></a>Step3、PackageParser.parsePackage()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> Package <span class="title">parsePackage</span><span class="params">(File sourceFile, String destCodePath, DisplayMetrics metrics, <span class="keyword">int</span> flags)</span> </span>&#123;</div><div class="line">    ...</div><div class="line">    mArchiveSourcePath = sourceFile.getPath();</div><div class="line">    ...</div><div class="line">    XmlResourceParser parser = <span class="keyword">null</span>;</div><div class="line">    AssetManager assmgr = <span class="keyword">null</span>;</div><div class="line">    <span class="keyword">boolean</span> assetError = <span class="keyword">true</span>;</div><div class="line">    </div><div class="line">    assmgr = <span class="keyword">new</span> AssetManager();</div><div class="line">    <span class="keyword">int</span> cookie = assmgr.addAssetPath(mArchiveSourcePath);</div><div class="line">    <span class="keyword">if</span>(cookie != <span class="number">0</span>) &#123;</div><div class="line">        parser = assmgr.openXmlResourceParser(cookie, <span class="string">"AndroidManifest.xml"</span>);</div><div class="line">        assetError = <span class="keyword">false</span>;</div><div class="line">    &#125;</div><div class="line">    ...</div><div class="line">    String[] errorText = <span class="keyword">new</span> String[<span class="number">1</span>];</div><div class="line">    Package pkg = <span class="keyword">null</span>;</div><div class="line">    Exception errorException = <span class="keyword">null</span>;</div><div class="line"></div><div class="line">    Resources res = <span class="keyword">new</span> Resources(assmgr, metrics, <span class="keyword">null</span>);</div><div class="line">    pkg = parsePackage(res, parser, flags, errorText);</div><div class="line">    ...</div><div class="line">    parser.close();</div><div class="line">    assmgr.close();</div><div class="line"></div><div class="line">    pkg.mPath = destCodePath;</div><div class="line">    pkg.mScanPath = mArchiveSourcePath;</div><div class="line">    pkg.mSignatures = <span class="keyword">null</span>;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> pkg;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>每一个Apk文件都是一个归档文件，里面包含了Android应用程序的配置文件AndroidManifest.xml，这里主要就是要对这个配置文件进行解析，从Apk归档文件中得到这个配置文件后调用另外一个parsePackage()。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> Package <span class="title">parsePackage</span><span class="params">(Resources res, XmlResourceParser parser, <span class="keyword">int</span> flags, String[] outError)</span> </span>&#123;</div><div class="line">    ...</div><div class="line">    String pkgName = parsePackageName(parser, attrs, flags, outError);</div><div class="line">    ...</div><div class="line">    TypedArray sa = res.obtainAttributes(attrs, com.android.internal.R.styleable.AndroidManifest);</div><div class="line">    ...</div><div class="line">    <span class="keyword">int</span> type;</div><div class="line">    <span class="keyword">while</span> ((type=parser.next()) != parser.END_DOCUMENT</div><div class="line">       &amp;&amp; (type != parser.END_TAG || parser.getDepth() &gt; outerDepth)) &#123;</div><div class="line">        <span class="keyword">if</span> (type == parser.END_TAG || type == parser.TEXT) &#123;<span class="keyword">continue</span>;&#125;</div><div class="line">        </div><div class="line">        String tagName = parser.getName();</div><div class="line">        <span class="keyword">if</span> (tagName.equals(<span class="string">"application"</span>)) &#123;</div><div class="line">            <span class="keyword">if</span> (!parseApplication(pkg, res, parser, attrs, flags, outError)) &#123;<span class="keyword">return</span> <span class="keyword">null</span>;&#125;</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(<span class="string">"permission-group"</span>)) &#123;  </div><div class="line">            ......  </div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(<span class="string">"permission"</span>)) &#123;  </div><div class="line">            ......  </div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(<span class="string">"permission-tree"</span>)) &#123;  </div><div class="line">            ......  </div><div class="line">        &#125; ...</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> pkg;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这函数就是对AndroidManifest.xml里的标签进行解析。<br><a href="http://developer.android.com/guide/topics/manifest/manifest-intro.html是谷歌官方文档。" target="_blank" rel="external">http://developer.android.com/guide/topics/manifest/manifest-intro.html是谷歌官方文档。</a><br>接下来对provider的解析存在在”application”里，对”application”的解析是调用parseApplication函数。</p>
<h4 id="Step4、PackageParser-parseApplication"><a href="#Step4、PackageParser-parseApplication" class="headerlink" title="Step4、PackageParser.parseApplication()"></a>Step4、PackageParser.parseApplication()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">parseApplication</span><span class="params">(Package owner, Resources res,</span></span></div><div class="line">            XmlPullParser parser, AttributeSet attrs, <span class="keyword">int</span> flags, String[] outError)&#123;</div><div class="line">    <span class="keyword">final</span> ApplicationInfo ai = owner.applicationInfo;</div><div class="line">    <span class="keyword">final</span> String pkgName = owner.applicationInfo.packageName;</div><div class="line">    </div><div class="line">    TypedArray sa = res.obtainAttributes(attrs,</div><div class="line">                com.android.internal.R.styleable.AndroidManifestApplication);</div><div class="line">                </div><div class="line">    <span class="keyword">int</span> type;</div><div class="line">    <span class="keyword">while</span> ((type=parser.next()) != parser.END_DOCUMENT</div><div class="line">           &amp;&amp; (type != parser.END_TAG || parser.getDepth() &gt; innerDepth)) &#123;</div><div class="line">        String tagName = parser.getName();</div><div class="line">        <span class="keyword">if</span> (tagName.equals(<span class="string">"activity"</span>)) &#123;</div><div class="line">            ...</div><div class="line">        &#125;</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(<span class="string">"provider"</span>)) &#123;</div><div class="line">        Provider p = parseProvider(owner, res, parser, attrs, flags, outError);</div><div class="line">        owner.providers.add(p);</div><div class="line">    &#125; ...</div><div class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>parseApplication通过对AndroidManifest.xml文件中的application标签进行解析，这里我们可以看到对于provider的解析是调用了parseProvider函数。</p>
<h4 id="Step5、parseProvider"><a href="#Step5、parseProvider" class="headerlink" title="Step5、parseProvider()"></a>Step5、parseProvider()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> Provider <span class="title">parseProvider</span><span class="params">(Package owner, Resources res,</span></span></div><div class="line">        XmlPullParser parser, AttributeSet attrs, <span class="keyword">int</span> flags, String[] outError) &#123;</div><div class="line">    TypedArray sa = res.obtainAttributes(attrs,</div><div class="line">            com.android.internal.R.styleable.AndroidManifestProvider);</div><div class="line">    <span class="keyword">if</span> (mParseProviderArgs == <span class="keyword">null</span>) &#123;</div><div class="line">        mParseProviderArgs = <span class="keyword">new</span> ParseComponentArgs(owner, outError,</div><div class="line">                com.android.internal.R.styleable.AndroidManifestProvider_name,</div><div class="line">                com.android.internal.R.styleable.AndroidManifestProvider_label,</div><div class="line">                com.android.internal.R.styleable.AndroidManifestProvider_icon, <span class="number">0</span>,</div><div class="line">                mSeparateProcesses,</div><div class="line">                com.android.internal.R.styleable.AndroidManifestProvider_process,</div><div class="line">                com.android.internal.R.styleable.AndroidManifestProvider_description,</div><div class="line">                com.android.internal.R.styleable.AndroidManifestProvider_enabled);</div><div class="line">        mParseProviderArgs.tag = <span class="string">"&lt;provider&gt;"</span>;</div><div class="line">    &#125;</div><div class="line">    ...</div><div class="line">    mParseProviderArgs.sa = sa;</div><div class="line">    mParseProviderArgs.flags = flags;</div><div class="line">    ...</div><div class="line">    Provider p = <span class="keyword">new</span> Provider(mParseProviderArgs, <span class="keyword">new</span> ProviderInfo());</div><div class="line">    ...</div><div class="line">    sa.recycle();</div><div class="line">    p.info.authority = cpname.intern();</div><div class="line">    <span class="keyword">return</span> p;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在这里解析我们的provider标签了，最后将解析完毕的Provider对象返回，这个返回会一直返回到<strong>Step2</strong>，然后调用另外一个installNewPackageLI()或者replacePackageLI()函数将获取的值保存。但其实在installNewPackageLI()或者replacePackageLI()函数核心里最后都会调用scanPackageLI()。所以将直接分析最后的scanPackageLI()函数</p>
<h4 id="Step6、scanPackageLI"><a href="#Step6、scanPackageLI" class="headerlink" title="Step6、scanPackageLI()"></a>Step6、scanPackageLI()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// All available providers, for your resolving pleasure.</span></div><div class="line"><span class="keyword">final</span> ProviderIntentResolver mProviders = <span class="keyword">new</span> ProviderIntentResolver();</div><div class="line">    </div><div class="line"><span class="keyword">private</span> PackageParser.<span class="function">Package <span class="title">scanPackageLI</span><span class="params">(PackageParser.Package pkg, <span class="keyword">int</span> parseFlags,</span></span></div><div class="line">        <span class="keyword">int</span> scanFlags, <span class="keyword">long</span> currentTime, UserHandle user) <span class="keyword">throws</span> PackageManagerException &#123;</div><div class="line">    <span class="keyword">boolean</span> success = <span class="keyword">false</span>;</div><div class="line">    <span class="keyword">final</span> PackageParser.Package res = scanPackageDirtyLI(pkg, parseFlags, scanFlags,</div><div class="line">            currentTime, user);</div><div class="line">    success = <span class="keyword">true</span>;</div><div class="line">    <span class="keyword">return</span> res;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">private</span> PackageParser.<span class="function">Package <span class="title">scanPackageDirtyLI</span><span class="params">(PackageParser.Package pkg, <span class="keyword">int</span> parseFlags,</span></span></div><div class="line">            <span class="keyword">int</span> scanFlags, <span class="keyword">long</span> currentTime, UserHandle user) &#123;</div><div class="line">    <span class="comment">// writer</span></div><div class="line">    <span class="keyword">synchronized</span> (mPackages) &#123;</div><div class="line">        ...</div><div class="line">        <span class="keyword">int</span> N = pkg.providers.size();</div><div class="line">        <span class="keyword">int</span> i;</div><div class="line">        <span class="keyword">for</span> (i=<span class="number">0</span>; i&lt;N; i++) &#123;</div><div class="line">            PackageParser.Provider p = pkg.providers.get(i);</div><div class="line">            p.info.processName = fixProcessName(pkg.applicationInfo.processName,</div><div class="line">                    p.info.processName, pkg.applicationInfo.uid);</div><div class="line">            mProviders.addProvider(p); <span class="comment">// 将Provider保存在本地了。</span></div><div class="line">            ...</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>最后我们走过相当长的旅程，终于将Provider从AndroidManifest里面拿出来并且保存到系统的PackageManagerService里面。以后每当我们要获取对应的Provider时候就可以从PMS里面查询并且获取。<br>需要注意的是：如果有相同的provider已经加载，新的就不加载进来了。</p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>通过六个步骤我们了解了APK里面的Provider怎么从安装包里面加载到PMS里，以提供外部使用。<br>最后总结下这六个步骤：</p>
<ol>
<li>扫描所有后缀为APK的文件并准备对其进行解析和安装。</li>
<li>扫描单个APK看是新安装还是覆盖安装，来做不同的区分解析和安装。</li>
<li>对每一个Apk文件包含的Android应用程序的配置文件AndroidManifest.xml进行解析。</li>
<li>深入解析AndroidManifest里的application标签。</li>
<li>具体解析provider标签。</li>
<li>将所有解析的信息保存到PMS相应的变量里。</li>
</ol>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2015/10/16/Android-浅析-ContentProvider-二-安装原理/" data-id="civ9405rs000kakqtklet7v0j" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Android/">Android</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Android-基础知识/">Android_基础知识</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ContentProvider/">ContentProvider</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Android-浅析-ContentProvider-一-使用" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/10/15/Android-浅析-ContentProvider-一-使用/" class="article-date">
  <time datetime="2015-10-15T11:49:39.000Z" itemprop="datePublished">2015-10-15</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/10/15/Android-浅析-ContentProvider-一-使用/">Android 浅析 ContentProvider (一) 使用</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <a id="more"></a>
<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><blockquote>
<p>Linus Benedict Torvalds : RTFSC – Read The Funning Source Code</p>
</blockquote>
<h2 id="概括"><a href="#概括" class="headerlink" title="概括"></a>概括</h2><blockquote>
<p>Content providers are one of the primary building blocks of Android applications, providing content to applications. They encapsulate data and provide it to applications through the single ContentResolver interface. A content provider is only required if you need to share data between multiple applications. For example, the contacts data is used by multiple applications and must be stored in a content provider. If you don’t need to share data amongst multiple applications you can use a database directly via SQLiteDatabase.</p>
</blockquote>
<p>我们先来看一张图片让我们对Content Provider有一个直观的了解：<br><img src="http://ww4.sinaimg.cn/large/7669bef3gw1exccy7p7lzj20l00bxwg9.jpg" alt="Content Provider"></p>
<p>ContentProvider提供了在应用程序之前共享数据的一种机制。<br>1、存储和获取数据提供了统一的接口。<br>2、对数据进行封装，不用关心数据存储的细节。<br>3、Android为常见的一些数据提供了默认的ContentProvider(包括音频、视频、图片和通讯录等)。<br>最主要的是ContentProvider对外共享数据统一了数据的访问方式。</p>
<h2 id="组件使用"><a href="#组件使用" class="headerlink" title="组件使用"></a>组件使用</h2><p>首先来看下如何实现一个ContentProvider功能：</p>
<h3 id="功能简述"><a href="#功能简述" class="headerlink" title="功能简述"></a>功能简述</h3><p>服务端：<br>有六个最主要的方法需要重写：<br>1、<strong>onCreate()</strong> which is called to initialize the provider.<br>2、<strong>query(Uri, String[], String, String[], String)</strong> which returns data to the caller.<br>3、<strong>insert(Uri, ContentValues)</strong> which inserts new data into the content provider.<br>4、<strong>update(Uri, ContentValues, String, String[])</strong> which updates existing data in the content provider.<br>5、<strong>delete(Uri, String, String[])</strong> which deletes data from the content provider.<br>6、<strong>getType(Uri)</strong> which returns the MIME type of data in the content provider.<br>注意：<br>insert()和update()方法有可能被多线程调用，一定要是线程安全的。<br>onCreate()方法只会调用一次，但要避免冗长的操作。</p>
<p>客户端：<br>通过<strong>ContentResolver</strong>可以自动获取Provider的实例，不必担心跨进程调用的细节。</p>
<h3 id="代码例子"><a href="#代码例子" class="headerlink" title="代码例子"></a>代码例子</h3><p>服务端：<br>AndroidManifest.xml<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">&lt;!-- android:exported="true" 指示该服务是否能够被其他应用程序组件调用或跟它交互。 --&gt;</div><div class="line">&lt;provider</div><div class="line">    android:name="com.unknow.jason.testdatabaseex.DatabaseProvider"</div><div class="line">    android:authorities="com.unknow.jason.testdatabaseex.provider"</div><div class="line">    android:exported="true"</div><div class="line">    android:enabled="true" &gt;</div><div class="line">&lt;/provider&gt;</div></pre></td></tr></table></figure></p>
<p>浅析：<br>AndroidManifest添加provider服务，在安装App的时候会自动注册这个Provider服务到AMS里作备份，这个服务最关键的点是<strong>authorities</strong>，作为Provider唯一标识，让其它程序可以在AMS里面查询到此Provider服务。<br>ps.更多关于Provider的权限可以看<a href="http://developer.android.com/guide/topics/manifest/provider-element.html。" target="_blank" rel="external">http://developer.android.com/guide/topics/manifest/provider-element.html。</a></p>
<p>DatabaseProvider.java<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DatabaseProvider</span> <span class="keyword">extends</span> <span class="title">ContentProvider</span> </span>&#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onCreate</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> Cursor <span class="title">query</span><span class="params">(Uri uri, String[] projection, String selection, String[] selectionArgs,</span></span></div><div class="line">                        String sortOrder) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> Uri <span class="title">insert</span><span class="params">(Uri uri, ContentValues values)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">update</span><span class="params">(Uri uri, ContentValues values, String selection, String[] selectionArgs)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">delete</span><span class="params">(Uri uri, String selection, String[] selectionArgs)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getType</span><span class="params">(Uri uri)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>浅析：</p>
<h4 id="Provider-最主要的六个方法。"><a href="#Provider-最主要的六个方法。" class="headerlink" title="Provider 最主要的六个方法。"></a>Provider 最主要的六个方法。</h4><p>getType():<br>Implement this to handle requests for the MIME type of the data at the given URI. The returned MIME type should start with <strong>vnd.android.cursor.item for a single record, or vnd.android.cursor.dir/ for multiple items.</strong><br><em>注意: 这方法有可能用于多线程。用于访问此信息的应用程序不需要权限；如果您的内容提供者需要读和/或写权限，或不导出，所有应用程序都可以调用此方法，不管其访问权限。这使他们能够检索URI的MIME类型时，调度意图。</em></p>
<p>insert():<br>Implement this to handle requests to insert a new row. As a courtesy, call notifyChange() after inserting.<br><em>注意: 这方法有可能用于多线程。</em></p>
<p>onCreate():<br>Implement this to initialize your content provider on startup. This method is called for all registered content providers on the application main thread at application launch time. <strong>It must not perform lengthy operations, or application startup will be delayed.</strong><br><em>注意： 如果你使用SQLite进行数据库操作，切勿在此方法中调用getReadableDatabase() or getWritableDatabase()方法，作为代替，可以使用onOpen(SQLiteDatabase)作为第一次初始数据库。</em></p>
<p>query():<br>Implement this to handle query requests from clients.<br><em>注意: 这方法有可能用于多线程。</em></p>
<p>delete():<br>Implement this to handle requests to delete one or more rows. The implementation should apply the selection clause when performing deletion, allowing the operation to affect multiple rows in a directory. As a courtesy, call notifyChange() after deleting.<br><em>注意: 这方法有可能用于多线程。如果一个特定的行要被删除，它会在URI的末尾解析出这一行的ID。</em></p>
<p>update():<br>Implement this to handle requests to update one or more rows. The implementation should update all rows matching the selection to set the columns according to the provided values map. As a courtesy, call notifyChange() after updating.<br><em>注意: 这方法有可能用于多线程。</em></p>
<p>sqlhelper.java<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SqlHelper</span> <span class="keyword">extends</span> <span class="title">SQLiteOpenHelper</span> </span>&#123;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String CREATE_BOOK = <span class="string">"create table Book ("</span></div><div class="line">            + <span class="string">"id integer primary key autoincrement, "</span></div><div class="line">            + <span class="string">"author text, "</span></div><div class="line">            + <span class="string">"price real, "</span></div><div class="line">            + <span class="string">"pages integer, "</span></div><div class="line">            + <span class="string">"name text)"</span>;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String CREATE_CATEGORY = <span class="string">"create table Category ("</span></div><div class="line">            + <span class="string">"id integer primary key autoincrement, "</span></div><div class="line">            + <span class="string">"category_name text)"</span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SqlHelper</span><span class="params">(Context context, String name, SQLiteDatabase.CursorFactory factory, <span class="keyword">int</span> version)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>(context, name, factory, version);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(SQLiteDatabase db)</span> </span>&#123;</div><div class="line">        db.execSQL(CREATE_BOOK);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onUpgrade</span><span class="params">(SQLiteDatabase db, <span class="keyword">int</span> oldVersion, <span class="keyword">int</span> newVersion)</span> </span>&#123;</div><div class="line">        db.execSQL(<span class="string">"drop table if exists Book"</span>);</div><div class="line">        onCreate(db);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>客户端：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">Uri uri = Uri.parse(<span class="string">"content://com.unknow.jason.testdatabaseex.provider/book"</span>);</div><div class="line">Cursor cursor = getContentResolver().query(uri, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>);</div><div class="line"></div><div class="line"><span class="keyword">if</span> (cursor != <span class="keyword">null</span>) &#123;</div><div class="line">    <span class="keyword">while</span> (cursor.moveToNext()) &#123;</div><div class="line">        String name = cursor.getString(cursor.getColumnIndex(<span class="string">"name"</span>));</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>浅析：<br>getContentResolver().query():<br>Query the given URI, returning a Cursor over the result set with optional support for cancellation.<br><em>为了更佳的性能，调用者应该遵循两点：<br>1、提供一个明确的projection，防止从存储中读取不需要的数据。<br>2、使用问号参数标记，如“电话=？”而不是在选择参数中的显式值，因此，不同的值的查询将被确认为缓存的目的相同的。</em></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2015/10/15/Android-浅析-ContentProvider-一-使用/" data-id="civ9405rs000dakqtcmusoprd" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Android/">Android</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Android-基础知识/">Android_基础知识</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ContentProvider/">ContentProvider</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Android-浅析-SharedPreferences-二-原理" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/09/20/Android-浅析-SharedPreferences-二-原理/" class="article-date">
  <time datetime="2015-09-20T13:03:15.000Z" itemprop="datePublished">2015-09-20</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/09/20/Android-浅析-SharedPreferences-二-原理/">Android 浅析 SharedPreferences (二) 原理</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <a id="more"></a>
<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><blockquote>
<p>Linus Benedict Torvalds : RTFSC – Read The Funning Source Code</p>
</blockquote>
<h2 id="概括"><a href="#概括" class="headerlink" title="概括"></a>概括</h2><blockquote>
<p>分析SharedPreferences的获取生成原理和修改原理。并且会看到为什么对于多进程是不安全的。</p>
</blockquote>
<h2 id="创建原理"><a href="#创建原理" class="headerlink" title="创建原理"></a>创建原理</h2><p>SharedPreferences的获取原理从getSharedPreferences函数开始。所以我们从getSharedPreferences函数为起点开始分析。</p>
<h3 id="ContextImpl"><a href="#ContextImpl" class="headerlink" title="ContextImpl"></a>ContextImpl</h3><p>我们知道Context的主要实现从ContextImpl开始，如何传进来的过程忽略。</p>
<p>getSharedPreferences函数返回的是一个SharedPreferences的对象并且是以单例实现的。因为此函数比较重要我们一步步来看。</p>
<h4 id="Step-1-getSharedPreferences"><a href="#Step-1-getSharedPreferences" class="headerlink" title="Step 1.getSharedPreferences()"></a>Step 1.getSharedPreferences()</h4><h5 id="Part-1-初始化映射对象"><a href="#Part-1-初始化映射对象" class="headerlink" title="Part 1.初始化映射对象"></a>Part 1.初始化映射对象</h5><p>ContextImpl 包含了一个比较复杂的内部全局私有变量<strong>sSharedPrefs</strong>，它的类型是<code>ArrayMap&lt;String, ArrayMap&lt;String, SharedPreferencesImpl&gt;&gt;</code>，比较难读，简单点就是从包名映射到preference名字到缓存preferences。<br>一开始我们先新建一个映射对象，然后获取包名赋予它初值。</p>
<h5 id="Part-2-创建SharedPrefs文件"><a href="#Part-2-创建SharedPrefs文件" class="headerlink" title="Part 2.创建SharedPrefs文件"></a>Part 2.创建SharedPrefs文件</h5><p>接下来我们通过一开始传进来的文件名去创建一个SharedPrefs文件，通过getSharedPrefsFile()函数返回一个”.xml”的文件对象。然后就会调用<code>new SharedPreferencesImpl(prefsFile, mode）</code>来创建一个SharedPreferencesImpl对象。</p>
<h3 id="SharedPreferencesImpl"><a href="#SharedPreferencesImpl" class="headerlink" title="SharedPreferencesImpl"></a>SharedPreferencesImpl</h3><p>SharedPreferences的其中一个重点在于它的创建，构造函数就是获取它对象的地方。</p>
<h4 id="Step-2-SharedPreferencesImpl"><a href="#Step-2-SharedPreferencesImpl" class="headerlink" title="Step 2.SharedPreferencesImpl()"></a>Step 2.SharedPreferencesImpl()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">mFile = file;</div><div class="line">mBackupFile = makeBackupFile(file);</div><div class="line">...</div><div class="line">startLoadFromDisk();</div></pre></td></tr></table></figure>
<p>构造函数功能是初始化一些变量和调用一些初始函数。<br>这里有两个变量值得注意，一个是mFile，保存preference的文件对象，另一个是mBackupFile，保存preference的备份文件对象。</p>
<p>首先来看makeBackupFile()函数</p>
<h4 id="Step-3-makeBackupFile"><a href="#Step-3-makeBackupFile" class="headerlink" title="Step 3.makeBackupFile()"></a>Step 3.makeBackupFile()</h4><p><code>return new File(prefsFile.getPath() + &quot;.bak&quot;);</code><br>makeBackupFile从字面意思也很好理解，就是生成一个备份的文件，主要是生成一个prefsFile的备份文件。</p>
<p>初始化的最后是调用startLoadFromDisk()函数进行操作。</p>
<h4 id="Step-4-startLoadFromDisk"><a href="#Step-4-startLoadFromDisk" class="headerlink" title="Step 4.startLoadFromDisk()"></a>Step 4.startLoadFromDisk()</h4><p><code>loadFromDiskLocked()</code><br>startLoadFromDisk() 的函数功能也很简单，开启一个线程单步调用loadFromDiskLocked()</p>
<h4 id="Step-5-loadFromDiskLocked"><a href="#Step-5-loadFromDiskLocked" class="headerlink" title="Step 5.loadFromDiskLocked()"></a>Step 5.loadFromDiskLocked()</h4><h5 id="Part-1-查看PrefsFile"><a href="#Part-1-查看PrefsFile" class="headerlink" title="Part 1.查看PrefsFile"></a>Part 1.查看PrefsFile</h5><p>loadFromDiskLocked()函数的第一步是查看备份文件是否已经存在，存在则讲原文件删除用备份文件替换。</p>
<h5 id="Part-2-加载PrefsFile"><a href="#Part-2-加载PrefsFile" class="headerlink" title="Part 2.加载PrefsFile"></a>Part 2.加载PrefsFile</h5><p>在确认PrefsFile文件可以被读取后会将PrefsFile文件内容加载到一个map里面，确认map不为空后会将它存到全局的mMap里，然后通过notifyAll发出一个通知，通知所有等待初始化完成的线程可以开始运作。</p>
<h3 id="ContextImpl-1"><a href="#ContextImpl-1" class="headerlink" title="ContextImpl"></a>ContextImpl</h3><h4 id="Step-6-getSharedPreferences"><a href="#Step-6-getSharedPreferences" class="headerlink" title="Step 6.getSharedPreferences()"></a>Step 6.getSharedPreferences()</h4><p>当创建完一个SharedPreferencesImpl后会将SharedPrefs对象保存到最初的数组里面。最后，如果这不是第一次加载，那么SharedPrefs对象不需要创建，但是会重新调用一次startLoadFromDisk()，让文件保持最新状态。</p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>SharedPreference的创建原理就到此为止了，到此用户就得到了SharedPreference的对象，方便未来的操作。</p>
<h2 id="获取原理"><a href="#获取原理" class="headerlink" title="获取原理"></a>获取原理</h2><p>获取的操作都是要在创建SharedPreference之后才可以操作的。</p>
<p>获取的过程我们以获取String为例。</p>
<h3 id="SharedPreferencesImpl-1"><a href="#SharedPreferencesImpl-1" class="headerlink" title="SharedPreferencesImpl"></a>SharedPreferencesImpl</h3><h4 id="getString"><a href="#getString" class="headerlink" title="getString()"></a>getString()</h4><p>首先通过SharedPreference对象调用getString方法。此方法有两个参数，一个是key值，也就是我们windows ini配置文件的key值一样，另一个就是默认参数。</p>
<p>首先进来会调用awaitLoadedLocked()来查看加载配置文件是否初始化完成。接着就很简单了，调用全局变量mMap来查找想要的信息。</p>
<h2 id="修改原理"><a href="#修改原理" class="headerlink" title="修改原理"></a>修改原理</h2><p>修改的操作都是要在创建SharedPreference之后才可以操作的。</p>
<p>修改的过程我们以修改一个String值为例。</p>
<h3 id="Activity"><a href="#Activity" class="headerlink" title="Activity"></a>Activity</h3><p>在我们调用的地方，我们首先通过preference.edit()函数获取SharedPreference的Editor类的对象。</p>
<h3 id="SharedPreferencesImpl-2"><a href="#SharedPreferencesImpl-2" class="headerlink" title="SharedPreferencesImpl"></a>SharedPreferencesImpl</h3><h4 id="Step-1-edit"><a href="#Step-1-edit" class="headerlink" title="Step 1.edit()"></a>Step 1.edit()</h4><p>edit()函数返回的是一个新建EditorImpl类的对象。<br>SharedPreferencesImpl.EditorImpl类里面有一个关键的变量mModified，这是一个Map，它会将以后要修改的值都放到里面去</p>
<h3 id="Activity-1"><a href="#Activity-1" class="headerlink" title="Activity"></a>Activity</h3><h4 id="Step-2-editor-putString"><a href="#Step-2-editor-putString" class="headerlink" title="Step 2.editor.putString()"></a>Step 2.editor.putString()</h4><p>这一步很简单，将我们要保存的值存入EditorImpl类里的变量mModified里。</p>
<h4 id="Step-3-editor-commit"><a href="#Step-3-editor-commit" class="headerlink" title="Step 3.editor.commit()"></a>Step 3.editor.commit()</h4><p>这一步就是调用editor的提交方法了。比较关键。</p>
<h3 id="SharedPreferencesImpl-3"><a href="#SharedPreferencesImpl-3" class="headerlink" title="SharedPreferencesImpl"></a>SharedPreferencesImpl</h3><h4 id="Step-4-commit"><a href="#Step-4-commit" class="headerlink" title="Step 4.commit()"></a>Step 4.commit()</h4><p>首先会调用commitToMemory函数返回一个MemoryCommitResult对象。所以我们首先来看下commitToMemory。</p>
<h4 id="Step-5-commitToMemory"><a href="#Step-5-commitToMemory" class="headerlink" title="Step 5.commitToMemory()"></a>Step 5.commitToMemory()</h4><p>MemoryCommitResult类是一个封装了commitmemory结果的一个类，里面有许多信息。<br>commitToMemory首先创建一个MemoryCommitResult对象。接着会克隆一个mMap对象。如果有设置监听消息会在这里设置一个值到MemoryCommitResult。接下来我们就会对mMap里面的值进行修改，在修改完成后会把之前我们所进行修改临时保存的全局变量mModified进行清空处理。然后返回出去MemoryCommitResult对象。</p>
<p>在commitToMemory返回一个结果类后会将它当作参数传入enqueueDiskWrite()函数里。</p>
<h4 id="Step-6-enqueueDiskWrite"><a href="#Step-6-enqueueDiskWrite" class="headerlink" title="Step 6.enqueueDiskWrite()"></a>Step 6.enqueueDiskWrite()</h4><p>enqueueDiskWrite()函数里面执行的是一个异步操作，在外部commit()函数会做一个await操作等待异步的完成。<br>在这个函数里会开启一个writeToDiskRunnable的线程，该线程做的事情是将传进来的MemoryCommitResult 里的数据写入到文件里。</p>
<h4 id="Step-7-writeToFile"><a href="#Step-7-writeToFile" class="headerlink" title="Step 7.writeToFile()"></a>Step 7.writeToFile()</h4><p>此函数首先会判断mFile文件是否存在，如果存在就再判断备份文件是否存在，备份文件不在的话就创建一个备份文件，然后删除原文件。<br>接着创建一个mFile的文件，将数据写入，再添加权限，做完后将备份文件删除。</p>
<p>做完后commit函数的职责就算完了，然后再广播监听者修改完成的消息。</p>
<h3 id="总结-1"><a href="#总结-1" class="headerlink" title="总结"></a>总结</h3><p>对于修改的原理，在多进程情况下如果两个修改的时机接近那么就很容易导致一方写不进去的问题，是因为会被另一个进程将写入的数据覆盖。这个问题目前的解决方案是不同的进程尽量使用不同的SharedPreference进行存储。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2015/09/20/Android-浅析-SharedPreferences-二-原理/" data-id="civ9405s7000yakqtylvh3gzh" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Android/">Android</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Android-基础知识/">Android_基础知识</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/SharedPreferences/">SharedPreferences</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Android-浅析-SharedPreferences-一-使用" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/09/20/Android-浅析-SharedPreferences-一-使用/" class="article-date">
  <time datetime="2015-09-20T12:19:43.000Z" itemprop="datePublished">2015-09-20</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/09/20/Android-浅析-SharedPreferences-一-使用/">Android 浅析 SharedPreferences (一) 使用</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <a id="more"></a>
<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><blockquote>
<p>Linus Benedict Torvalds : RTFSC – Read The Funning Source Code</p>
</blockquote>
<h2 id="概括"><a href="#概括" class="headerlink" title="概括"></a>概括</h2><blockquote>
<p>The SharedPreferences class provides a general framework that allows you to save and retrieve persistent key-value pairs of primitive data types. You can use SharedPreferences to save any primitive data: booleans, floats, ints, longs, and strings. This data will persist across user sessions (even if your application is killed).</p>
</blockquote>
<p>翻译：<br>SharedPreferences类提供了一个通用的框架，允许你保存和检索原始数据类型的持久的键-值对。你可以使用SharedPreferences保存任何原始数据：布尔型，整型，漂浮，渴望，和字符串。此数据将持续整个用户周期（即使您的应用程序被杀害）。</p>
<h2 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h2><p>去使用SharedPreference有两个方法：</p>
<ul>
<li>getSharedPreferences()：使用这个函数如果你需要多个preferences文件需在第一个参数指定的名称来区分。</li>
<li>getPreferences()：如果你只需要一个preferences文件，请使用此函数。因为这将是您的活动的唯一首选文件，您不需要提供名称。</li>
</ul>
<h3 id="写入SharedPreference"><a href="#写入SharedPreference" class="headerlink" title="写入SharedPreference"></a>写入SharedPreference</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">SharedPreferences preference = <span class="keyword">null</span>;</div><div class="line">preference = context.getSharedPreferences(<span class="string">"text"</span>, <span class="number">0</span>);</div><div class="line"></div><div class="line">SharedPreferences.Editor editor = preference.edit();</div><div class="line">editor.putBoolean(<span class="string">"silentMode"</span>, <span class="keyword">false</span>);</div><div class="line"></div><div class="line">editor.commit();</div></pre></td></tr></table></figure>
<p>写入SharedPreferecen非常简单，首先是获取一个preference的实例对象，通过这个实例对象拿到Editor的引用，然后就可以传入想要传入的值，最后，再调用commit来完成。</p>
<h3 id="获取SharedPreference"><a href="#获取SharedPreference" class="headerlink" title="获取SharedPreference"></a>获取SharedPreference</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">SharedPreferences preference = <span class="keyword">null</span>;</div><div class="line">preference = context.getSharedPreferences(<span class="string">"text"</span>, <span class="number">0</span>);</div><div class="line"></div><div class="line"><span class="keyword">boolean</span> silent =  preference.getBoolean(<span class="string">"silentMode"</span>, <span class="keyword">false</span>);</div></pre></td></tr></table></figure>
<p>获取SharedPreferecen也很容易，同样首先获取一个preference的实例对象，之后便可通过key直接获取想要获取的值了。</p>
<h2 id="主要类"><a href="#主要类" class="headerlink" title="主要类"></a>主要类</h2><h3 id="SharedPreferences"><a href="#SharedPreferences" class="headerlink" title="SharedPreferences"></a>SharedPreferences</h3><blockquote>
<p>Interface for accessing and modifying preference data returned by getSharedPreferences(String, int). For any particular set of preferences, there is a single instance of this class that all clients share. Modifications to the preferences must go through an SharedPreferences.Editor object to ensure the preference values remain in a consistent state and control when they are committed to storage. Objects that are returned from the various get methods must be treated as immutable by the application.<br>翻译：<br>这是个接口类，给予从getSharedPreferences(String, int)函数访问和修改preference数据的功能。每个独立的preferences，这里都有一个唯一的接口类给所有客户端使用。修改preferences数据必须通过SharedPreferences接口。Editor对象保证preference值保持一致的状态和控制他们提交到存储里。从各种各样的get方法返回的对象必须由应用程序被视为不可变的。</p>
</blockquote>
<p><strong>注意：现在还不支持多进程安全，以后会添加。</strong></p>
<h4 id="内部类"><a href="#内部类" class="headerlink" title="内部类"></a>内部类</h4><h5 id="Editor"><a href="#Editor" class="headerlink" title="Editor"></a>Editor</h5><blockquote>
<p>Interface used for modifying values in a SharedPreferences object. All changes you make in an editor are batched, and not copied back to the original SharedPreferences until you call commit() or apply()<br>翻译：接口类用来在SharedPreferences对象里修改参数。所有的你做的修改都是批处理，并且不会复制回原来的SharedPreferences对象直到你调用commit() 或 apply()函数。</p>
</blockquote>
<h5 id="OnSharedPreferenceChangeListener"><a href="#OnSharedPreferenceChangeListener" class="headerlink" title="OnSharedPreferenceChangeListener"></a>OnSharedPreferenceChangeListener</h5><blockquote>
<p>Interface definition for a callback to be invoked when a shared preference is changed.<br>翻译：接口类用来作为一个回调在一个preference被修改是调用。</p>
</blockquote>
<h4 id="内部主要方法："><a href="#内部主要方法：" class="headerlink" title="内部主要方法："></a>内部主要方法：</h4><h5 id="SharedPreferences-edit"><a href="#SharedPreferences-edit" class="headerlink" title="SharedPreferences.edit()"></a>SharedPreferences.edit()</h5><blockquote>
<p>创建一个新的Editor类型给这个preferences，通过这个你可以修改preferences的数据和自动提交这些修改到这个SharedPreferences对象。</p>
</blockquote>
<p>注意：需要调用<code>commit()</code>在你每次通过Editor对SharedPreferences进行修改后。</p>
<h5 id="SharedPreferences-Editor-commit"><a href="#SharedPreferences-Editor-commit" class="headerlink" title="SharedPreferences.Editor.commit()"></a>SharedPreferences.Editor.commit()</h5><blockquote>
<p>提交你对于preferences的修改给SharedPreferences的对象。这会自动执行所要求的修改或者替换所有存在的SharedPreferences。</p>
</blockquote>
<p>注意：如果同时提交，最后的提交动作会被执行。</p>
<h5 id="SharedPreferences-Editor-apply"><a href="#SharedPreferences-Editor-apply" class="headerlink" title="SharedPreferences.Editor.apply()"></a>SharedPreferences.Editor.apply()</h5><blockquote>
<p>功能跟commit() 函数一样。</p>
</blockquote>
<p>不同：apply()会将它的preferences同步写出到持久存储，apply()会马上提交它的修改到内存中的SharedPreferences但会异步提交到硬盘并且你不会收到任何报错。如果其他editor在这个SharedPreferences也做了一个commit()当apply()正在写是，commit()将会被阻塞。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2015/09/20/Android-浅析-SharedPreferences-一-使用/" data-id="civ9405s7000wakqtysu8h2d7" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Android/">Android</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Android-基础知识/">Android_基础知识</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/SharedPreferences/">SharedPreferences</a></li></ul>

    </footer>
  </div>
  
</article>


  


  <nav id="page-nav">
    <a class="extend prev" rel="prev" href="/page/2/">&laquo; __('prev')</a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span>
  </nav>
</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/FreeLoad/">FreeLoad</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Android/">Android</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Android-基础知识/">Android_基础知识</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Ashmem/">Ashmem</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Binder/">Binder</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Broadcast/">Broadcast</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ButterKnife/">ButterKnife</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ContentProvider/">ContentProvider</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/EventBus/">EventBus</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/FreeLoad/">FreeLoad</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Java/">Java</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/RxJava/">RxJava</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SharedPreferences/">SharedPreferences</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Volley/">Volley</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/开源库/">开源库</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/智能指针/">智能指针</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/注解/">注解</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/Android/" style="font-size: 20px;">Android</a> <a href="/tags/Android-基础知识/" style="font-size: 18.33px;">Android_基础知识</a> <a href="/tags/Ashmem/" style="font-size: 10px;">Ashmem</a> <a href="/tags/Binder/" style="font-size: 13.33px;">Binder</a> <a href="/tags/Broadcast/" style="font-size: 13.33px;">Broadcast</a> <a href="/tags/ButterKnife/" style="font-size: 11.67px;">ButterKnife</a> <a href="/tags/ContentProvider/" style="font-size: 15px;">ContentProvider</a> <a href="/tags/EventBus/" style="font-size: 11.67px;">EventBus</a> <a href="/tags/FreeLoad/" style="font-size: 10px;">FreeLoad</a> <a href="/tags/Java/" style="font-size: 10px;">Java</a> <a href="/tags/RxJava/" style="font-size: 11.67px;">RxJava</a> <a href="/tags/SharedPreferences/" style="font-size: 11.67px;">SharedPreferences</a> <a href="/tags/Volley/" style="font-size: 11.67px;">Volley</a> <a href="/tags/开源库/" style="font-size: 16.67px;">开源库</a> <a href="/tags/智能指针/" style="font-size: 10px;">智能指针</a> <a href="/tags/注解/" style="font-size: 10px;">注解</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/11/">November 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/09/">September 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/11/">November 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/10/">October 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/09/">September 2015</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2016/11/08/hello-world/">Hello World</a>
          </li>
        
          <li>
            <a href="/2016/09/22/Android-浅析-RxJava-二-原理/">Android 浅析 RxJava (二) 原理</a>
          </li>
        
          <li>
            <a href="/2016/09/22/Android-浅析-RxJava-一-使用/">Android 浅析 RxJava (一) 使用</a>
          </li>
        
          <li>
            <a href="/2016/09/21/Java-注解-Dependency-injection/">Java 注解 Dependency injection</a>
          </li>
        
          <li>
            <a href="/2016/09/21/Android-浅析-ButterKnife-二-源码解析/">Android 浅析 ButterKnife (二) 源码解析</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2016 John Doe<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div>
</body>
</html>